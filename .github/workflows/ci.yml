name: Backend CI/CD

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  # ============================================
  # CI Pipeline - Build, Test, Lint, Format
  # ============================================
  ci:
    name: CI - Build, Test & Quality Checks
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U test -d testdb"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    env:
      SPRING_PROFILES_ACTIVE: test
      SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/testdb
      SPRING_DATASOURCE_USERNAME: test
      SPRING_DATASOURCE_PASSWORD: test

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Wait for Postgres to be ready
        run: |
          for i in {1..20}; do
            if pg_isready -h localhost -p 5432 -U test -d testdb; then
              echo "Postgres ready"
              exit 0
            fi
            echo "Waiting for Postgres..."
            sleep 2
          done
          echo "Postgres did not become ready in time"
          exit 1

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Cache Gradle
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # Quality Check 1: Checkstyle (Linting)
      - name: Run Checkstyle
        run: ./gradlew checkstyleMain checkstyleTest --continue || true

      # Quality Check 2: Spotless (Formatting)
      - name: Check code formatting with Spotless
        run: ./gradlew spotlessCheck || true

      # Build and run tests (exclude tests that require real network calls)
      - name: Build project
        run: ./gradlew clean build --info -PexcludeTests="**/Auth0ManagementServiceTest*"

      # Generate test report summary
      - name: Test Summary
        if: always()
        run: |
          echo "## ðŸ§ª Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f build/reports/tests/test/index.html ]; then
            echo "âœ… Tests completed - see artifacts for detailed report" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No test report generated" >> $GITHUB_STEP_SUMMARY
          fi

      # Upload test reports
      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: build/reports/tests/
          retention-days: 7

  # ============================================
  # CD Pipeline - Deploy to DigitalOcean
  # ============================================
  cd:
    name: CD - Deploy to DigitalOcean
    needs: ci
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    environment:
      name: production

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install doctl (DigitalOcean CLI)
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}

      - name: Trigger DigitalOcean App Platform Deployment
        run: |
          doctl apps create-deployment ${{ secrets.DIGITALOCEAN_BACKEND_APP_ID }} --wait

      - name: Get Deployment URL
        id: deploy
        run: |
          url=$(doctl apps get ${{ secrets.DIGITALOCEAN_BACKEND_APP_ID }} --format LiveURL --no-header)
          echo "url=$url" >> $GITHUB_OUTPUT

      - name: Deployment Summary
        run: |
          echo "## ðŸš€ Backend Deployment to DigitalOcean Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Production URL:** ${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed at:** $(date)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # PR Status Check
  # ============================================
  pr-check:
    name: PR Quality Gate
    needs: ci
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: PR Check Summary
        run: |
          echo "## âœ… Backend Pull Request Quality Checks Passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All CI checks have passed:" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Checkstyle (Code Quality)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Spotless (Code Formatting)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Unit/Integration Tests Passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Ready for merge!** Deployment will trigger automatically on merge to main." >> $GITHUB_STEP_SUMMARY
