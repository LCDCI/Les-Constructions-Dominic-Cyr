
@startuml

actor "o:Owner" as Owner

participant "page:CreateSchedulePage" as Page
participant "reqDTO:ScheduleRequestDTO" as ReqDTO
participant "ctrl:ScheduleController" as Controller

participant "svc:ScheduleServiceImpl" as Service
participant "validator:ScheduleValidator" as Validator
participant "mapper:ScheduleMapper" as Mapper

participant "projRepo:ProjectRepository" as ProjectRepo
participant "proj:Project" as Project
participant "lotRepo:LotRepository" as LotRepo
participant "lot:Lot" as Lot
participant "sched:Schedule" as Schedule
participant "schedRepo:ScheduleRepository" as ScheduleRepo
participant "schedDb:Schedule" as ScheduleDb
participant "db:PostgreSQL" as DB

participant "resDTO:ScheduleResponseDTO" as ResDTO

participant "taskReqDTO:TaskRequestDTO" as TaskReqDTO
participant "taskCtrl:TaskController" as TaskController
participant "taskSvc:TaskServiceImpl" as TaskService
participant "taskValidator:TaskValidator" as TaskValidator
participant "taskMapper:TaskMapper" as TaskMapper
participant "task:Task" as Task
participant "taskRepo:TaskRepository" as TaskRepo
participant "taskDb:Task" as TaskDb
participant "taskResDTO:TaskResponseDTO" as TaskResDTO

ref over Owner, Controller : JWT Authentication (Security Filter)

Owner -> Page : input schedule details & submit
activate Page

create ReqDTO
Page -> ReqDTO : <<create>>

Page -> Controller : POST /api/v1/projects/{projectId}/schedules (reqDTO)
activate Controller

Controller -> Service : addScheduleToProject(projectId, reqDTO)
activate Service

Service -> Validator : validate(reqDTO)
activate Validator

alt Validation Fails
    Validator --> Service : throw BusinessValidationException
    Service --> Controller : error
    Controller --> Page : HTTP 400 (Invalid input)
    Page --> Owner : Display error message
else Validation Passes
    Validator --> Service : void
    deactivate Validator

    Service -> ProjectRepo : findByProjectIdentifier(projectId)
    activate ProjectRepo
    ProjectRepo -> DB : SELECT * FROM projects WHERE project_identifier = ?
    activate DB
    
    create Project
    DB -> Project : <<create>>
    
    DB --> ProjectRepo : proj
    deactivate DB
    ProjectRepo --> Service : proj
    deactivate ProjectRepo

    alt Project Not Found
        Service --> Controller : throw NotFoundException
        Controller --> Page : HTTP 404 (Project not found)
        Page --> Owner : Display error
    else Project Found

        Service -> LotRepo : findByLotIdentifier(reqDTO.getLotId())
        activate LotRepo
        LotRepo -> DB : SELECT * FROM lots WHERE lot_identifier = ?
        activate DB
        
        create Lot
        DB -> Lot : <<create>>
        
        DB --> LotRepo : lot
        deactivate DB
        LotRepo --> Service : lot
        deactivate LotRepo

        alt Lot Not Found
            Service --> Controller : throw NotFoundException
            Controller --> Page : HTTP 404 (Lot not found)
            Page --> Owner : Display error
        else Lot Found

            Service -> Mapper : requestDTOToEntity(reqDTO, proj, lot)
            activate Mapper
            
            create Schedule
            Mapper -> Schedule : <<create>>
            
            Mapper --> Service : sched
            deactivate Mapper

            Service -> ScheduleRepo : save(sched)
            activate ScheduleRepo
            
            create ScheduleDb
            ScheduleRepo -> ScheduleDb : <<create>>
            
            ScheduleRepo -> DB : INSERT INTO schedules (schedule_identifier, start_date, end_date, description, project_id, lot_id) VALUES (...)
            activate DB
            DB --> ScheduleRepo : row inserted
            deactivate DB
            
            ScheduleRepo --> Service : schedDb
            deactivate ScheduleRepo

            Service -> Mapper : entityToResponseDTO(schedDb)
            activate Mapper
            
            create ResDTO
            Mapper -> ResDTO : <<create>>
            
            Mapper --> Service : resDTO
            deactivate Mapper

            Service --> Controller : resDTO
            deactivate Service

            Controller --> Page : HTTP 201 Created (resDTO)
            deactivate Controller

            Page --> Owner : Display success & schedule details
            deactivate Page

            loop For each task to add
                Owner -> Page : input task details & submit
                activate Page
                
                create TaskReqDTO
                Page -> TaskReqDTO : <<create>>
                
                Page -> TaskController : POST /api/v1/schedules/{scheduleId}/tasks (taskReqDTO)
                activate TaskController
                
                TaskController -> TaskService : addTaskToSchedule(scheduleId, taskReqDTO)
                activate TaskService
                
                TaskService -> TaskValidator : validate(taskReqDTO)
                activate TaskValidator
                
                alt Task Validation Fails
                    TaskValidator --> TaskService : throw BusinessValidationException
                    TaskService --> TaskController : error
                    TaskController --> Page : HTTP 400 (Invalid task data)
                    Page --> Owner : Display task error
                else Task Validation Passes
                    TaskValidator --> TaskService : void
                    deactivate TaskValidator
                    
                    TaskService -> TaskMapper : requestDTOToEntity(taskReqDTO, schedDb)
                    activate TaskMapper
                    
                    create Task
                    TaskMapper -> Task : <<create>>
                    
                    TaskMapper --> TaskService : task
                    deactivate TaskMapper
                    
                    TaskService -> TaskRepo : save(task)
                    activate TaskRepo
                    
                    create TaskDb
                    TaskRepo -> TaskDb : <<create>>
                    
                    TaskRepo -> DB : INSERT INTO tasks (task_identifier, title, description, start_date, end_date, status, priority, estimated_hours, assigned_user_id, schedule_id) VALUES (...)
                    activate DB
                    DB --> TaskRepo : row inserted
                    deactivate DB
                    
                    TaskRepo --> TaskService : taskDb
                    deactivate TaskRepo
                    
                    TaskService -> TaskMapper : entityToResponseDTO(taskDb)
                    activate TaskMapper
                    
                    create TaskResDTO
                    TaskMapper -> TaskResDTO : <<create>>
                    
                    TaskMapper --> TaskService : taskResDTO
                    deactivate TaskMapper
                    
                    TaskService --> TaskController : taskResDTO
                    deactivate TaskService
                    
                    TaskController --> Page : HTTP 201 Created (taskResDTO)
                    deactivate TaskController
                    
                    Page --> Owner : Display task added confirmation
                    deactivate Page
                end
            end
        end
    end
end

@enduml