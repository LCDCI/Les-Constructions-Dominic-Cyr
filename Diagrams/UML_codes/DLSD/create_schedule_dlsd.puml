@startuml

actor Owner

participant CreateSchedulePage as Page
participant ScheduleController as Controller
participant ScheduleServiceImpl as Service
participant ScheduleMapper as Mapper
participant ProjectRepository as ProjectRepo
participant LotRepository as LotRepo
participant ScheduleRepository as ScheduleRepo
participant PostgreSQL as DB

ref over Owner, Controller
    <<include>> JWT Authentication
    (Security Filter validates Owner token)
end ref

Owner -> Page : input schedule details & submit
activate Page

create "reqDTO:ScheduleRequestDTO" as ReqDTO
Page -> ReqDTO : <<create>>

Page -> Controller : POST /api/v1/projects/{projectId}/schedules (reqDTO)
activate Controller

Controller -> Service : addScheduleToProject(projectId, reqDTO)
activate Service

Service -> Service : validateScheduleRequest(reqDTO)

alt Validation Fails
    Service --> Controller : throw InvalidInputException
    Controller --> Page : HTTP 400 (Invalid input)
    Page --> Owner : Display error message
    
    note right of Page
        <<extend>> Schedule Validation Error
        Extension point: FDUC Step 3.1
    end note
    
else Validation Passes

    Service -> ProjectRepo : findByProjectIdentifier(projectId)
    activate ProjectRepo
    ProjectRepo -> DB : SELECT * FROM projects WHERE project_identifier = ?
    activate DB
    
    create "proj:Project" as Project
    DB -> Project : <<create>>
    
    DB --> ProjectRepo : proj
    deactivate DB
    ProjectRepo --> Service : proj
    deactivate ProjectRepo

    alt Project Not Found
        Service --> Controller : throw NotFoundException
        Controller --> Page : HTTP 404 (Project not found)
        Page --> Owner : Display error
        
        note right of Page
            <<extend>> Project Not Found
            Extension point: FDUC Step 4.1
        end note
        
    else Project Found

        Service -> LotRepo : findByLotIdentifier(reqDTO.getLotId())
        activate LotRepo
        LotRepo -> DB : SELECT * FROM lots WHERE lot_identifier = ?
        activate DB
        
        create "lot:Lot" as Lot
        DB -> Lot : <<create>>
        
        DB --> LotRepo : lot
        deactivate DB
        LotRepo --> Service : lot
        deactivate LotRepo

        alt Lot Not Found
            Service --> Controller : throw NotFoundException
            Controller --> Page : HTTP 404 (Lot not found)
            Page --> Owner : Display error
            
            note right of Page
                <<extend>> Lot Not Found
                Extension point: FDUC Step 4.1
            end note
            
        else Lot Found

            Service -> Mapper : requestDTOToEntity(reqDTO, proj, lot)
            activate Mapper
            
            create "sched:Schedule" as Schedule
            Mapper -> Schedule : <<create>>
            
            Mapper --> Service : sched
            deactivate Mapper

            Service -> ScheduleRepo : save(sched)
            activate ScheduleRepo
            
            create "schedDb:Schedule" as ScheduleDb
            ScheduleRepo -> ScheduleDb : <<create>>
            
            ScheduleRepo -> DB : INSERT INTO schedules (schedule_identifier, start_date, end_date, description, project_id, lot_id) VALUES (...)
            activate DB
            DB --> ScheduleRepo : row inserted
            deactivate DB
            
            ScheduleRepo --> Service : schedDb
            deactivate ScheduleRepo

            Service -> Mapper : entityToResponseDTO(schedDb)
            activate Mapper
            
            create "resDTO:ScheduleResponseDTO" as ResDTO
            Mapper -> ResDTO : <<create>>
            
            Mapper --> Service : resDTO
            deactivate Mapper

            Service --> Controller : resDTO
            deactivate Service

            Controller --> Page : HTTP 201 Created (resDTO)
            deactivate Controller

            Page --> Owner : Display success & schedule details
            deactivate Page

            loop For each task to add
                Owner -> Page : input task details & submit
                activate Page
                
                ref over Page, DB
                    Add Task to Schedule
                    ---
                    1. Validate task data (dates, required fields) via TaskService.validateTaskRequest()
                    2. Map TaskRequestDTO to Task entity
                    3. Persist task with schedule_id foreign key
                    4. Return TaskResponseDTO
                    ---
                    Follows same three-tier pattern as schedule creation:
                    TaskController -> TaskService (validates internally) -> TaskMapper -> TaskRepository -> DB
                    <<extend>> Task Validation Error if validation fails
                end ref
                
                Page --> Owner : Display task added confirmation
                deactivate Page
            end
        end
    end
end

@enduml